#cloud-config
coreos:
  etcd2:
    # use the same discovery token for the central service machines
    # make sure you have used the discovery token to bootstrap the
    # central service successfully
    # this etcd will fallback to proxy automatically
    discovery: <%=@disco_url%>
    # listen on both the official ports and the legacy ports
    # legacy ports can be omitted if your application doesn't depend on them
    listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001
    #  flannel:
#    interface: "eth1"
  fleet:
    metadata: "role=kube-master"
    etcd_servers: "http://localhost:2379"
  flannel:
    interface: "eth1"
  locksmith:
    endpoint: "http://localhost:2379"
  units:
    - name: 00-eth1.network
      runtime: true
      content: |
        [Match]
        Name=eth1

        [Network]
        DHCP=yes
        DNS=10.0.3.2
        Gateway=10.0.3.2
    - name: systemd-networkd.service
      command: stop
    - name: systemd-networkd.service
      command: start
    - name: get-ip-for-flannel.service
      command: start
      content: |
        [Unit]
        Description=Setup flannel options.

        [Service]
        Type=oneshot
        ExecStart=/bin/sh -c "mkdir -p /etc/flannel/"
        ExecStart=/usr/bin/echo "FLANNELD_IFACE=$(ifconfig eth1 | grep 'inet ' | awk '{print $2}'0)" > /etc/flannel/options.env
        ExecStart=/usr/bin/echo "FLANNELD_ETCD_ENDPOINTS=http://0.0.0.0:2379,http://0.0.0.0:4001" >> /etc/flannel/options.env
    - name: etcd2.service
      command: start
    - name: fleet.service
      command: start
    - name : flanneld.service
      drop-ins:
        - name: 40-ExecStartPre-symlink.conf
          content: |
            [Service]
            ExecStartPre=/usr/bin/ln -sf /etc/flannel/options.env /run/flannel/options.env
      command: start
    - name: docker.service
      drop-ins:
        - name: 40-flannel.conf
          content: |
            [Unit]
            Requires=flanneld.service
            After=flanneld.service
      command: start

